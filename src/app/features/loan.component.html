<div class="content-box-minor">
  <h2 class="text-3xl font-bold text-blue-700 mb-4">
    üíµ C√¥ng C·ª• T√≠nh Kho·∫£n Vay (EMI)
  </h2>
  <form
    [formGroup]="form"
    class="grid grid-cols-1 md:grid-cols-3 gap-6 finance-block"
  >
    <!-- D√íNG EMI: chi·∫øm full 3 c·ªôt -->
    <div class="finance-row md:col-span-3">
      <!-- Input -->
      <div class="finance-control">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Kho·∫£n vay g·ªëc (VND)</mat-label>
          <input matInput type="text" formControlName="principal" currencyInput/>
          <mat-error *ngIf="form.get('principal')?.invalid">
            Kho·∫£n vay ph·∫£i &gt; 0
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Label EMI -->
      <label class="finance-label">
        <strong>EMI:</strong>
      </label>

      <!-- Value EMI -->
      <div class="finance-value">
        <span class="text-green-600">
          {{ currencyFormat(monthlyPayment) }}
        </span>
        <span class="finance-unit">VND</span>
      </div>
    </div>

    <div class="finance-row md:col-span-3">
      <!-- Input -->
      <div class="finance-control">
        <mat-form-field appearance="outline">
          <mat-label>L√£i su·∫•t nƒÉm (%)</mat-label>
          <input matInput type="number" formControlName="annualRate" />
        </mat-form-field>
      </div>

      <!-- Label EMI -->
      <label class="finance-label">
        <strong>T·ªïng l√£i:</strong>
      </label>

      <!-- Value EMI -->
      <div class="finance-value">
        <span class="text-green-600">
          {{ currencyFormat(totalInterest) }}
        </span>
        <span class="finance-unit">VND</span>
      </div>
    </div>

    <div class="finance-row md:col-span-3">
      <!-- Input -->
      <div class="finance-control">
        <mat-form-field appearance="outline">
          <mat-label>K·ª≥ h·∫°n (th√°ng)</mat-label>
          <input matInput type="number" formControlName="termMonths" />
        </mat-form-field>
      </div>

      <!-- Label EMI -->
      <label class="finance-label">
        <strong>T·ªïng thanh to√°n:</strong>
      </label>

      <!-- Value EMI -->
      <div class="finance-value">
        <span class="text-green-600">
          {{ currencyFormat(totalPayment) }}
        </span>
        <span class="finance-unit">VND</span>
      </div>
    </div>

    <div></div>
  </form>

  <div class="table-scroll">
    <!-- TABLE -->
    <div class="mt-6" *ngIf="pagedSchedule.length">
      <table mat-table [dataSource]="pagedSchedule">
        <ng-container matColumnDef="period">
          <th mat-header-cell *matHeaderCellDef>K·ª≥</th>
          <td mat-cell *matCellDef="let e">{{ e.period }}</td>
        </ng-container>

        <ng-container matColumnDef="startingBalance">
          <th mat-header-cell *matHeaderCellDef>V·ªën ƒë·∫ßu k·ª≥</th>
          <td mat-cell *matCellDef="let e">
            {{ currencyFormat(e.startingBalance) }}
          </td>
        </ng-container>

        <ng-container matColumnDef="interestPaid">
          <th mat-header-cell *matHeaderCellDef>Tr·∫£ l√£i</th>
          <td mat-cell *matCellDef="let e" class="text-red-600">
            {{ currencyFormat(e.interestPaid) }}
          </td>
        </ng-container>

        <ng-container matColumnDef="principalPaid">
          <th mat-header-cell *matHeaderCellDef>Tr·∫£ g·ªëc</th>
          <td mat-cell *matCellDef="let e" class="text-green-600">
            {{ currencyFormat(e.principalPaid) }}
          </td>
        </ng-container>

        <ng-container matColumnDef="endingBalance">
          <th mat-header-cell *matHeaderCellDef>D∆∞ cu·ªëi</th>
          <td mat-cell *matCellDef="let e">
            {{ currencyFormat(e.endingBalance) }}
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>
    <div class="pagination" *ngIf="totalPages > 1">
      <button
        mat-stroked-button
        (click)="setPage(currentPage - 1)"
        [disabled]="currentPage === 0"
      >
        ‚óÄ Tr∆∞·ªõc
      </button>

      <span> NƒÉm {{ currentPage + 1 }} / {{ totalPages }} </span>

      <button
        mat-stroked-button
        (click)="setPage(currentPage + 1)"
        [disabled]="currentPage >= totalPages - 1"
      >
        Sau ‚ñ∂
      </button>
    </div>
  </div>

  <!-- CHART + EXPORT -->
<div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">

<div class="lg:col-span-2 ocb-card p-4"  *ngIf="chartVisible">
  <div class="text-sm font-semibold mb-3 text-gray-700">
    Bi·ªÉu ƒë·ªì d√≤ng ti·ªÅn thanh to√°n
  </div>

  <!-- üëá div n√†y QUAN TR·ªåNG -->
  <div class="relative h-[320px]">
    <canvas #paymentChart class="w-full h-full"></canvas>
  </div>
</div>


  <!-- Action -->
  <div class="flex flex-col justify-end gap-3">
    <button
      mat-raised-button
      color="primary"
      (click)="exportExcel()"
    >
      Xu·∫•t Excel
    </button>
  </div>

</div>
</div>
